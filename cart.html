<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles.css">

    <title>Shopping Cart</title>
</head>
<body>
    <h2>Shopping Cart</h2>
    <div id="cart-items"></div>
    <p><strong>Total: R<span id="total">0.00</span></strong></p>
    
    <label>
        <input type="checkbox" id="delivery"> Add Delivery (R220)
    </label>


    <div class="popup">
        <button class="btn btn-outline-light my-5" id="popup-pay">Checkout</button>
        <p class="popup-message" id="popup-message"></p>
    </div>

    <script src="https://js.yoco.com/sdk/v1/yoco-sdk-web.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>


    <script>
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let cartItems = document.getElementById('cart-items');
        let totalElement = document.getElementById('total');
        let deliveryCheckbox = document.getElementById('delivery');

        function renderCart() {
            cartItems.innerHTML = '';
            let total = 0;

            cart.forEach(item => {
                let itemTotal = item.price * item.quantity;
                total += itemTotal;

                let itemDiv = document.createElement('div');
                itemDiv.innerHTML = `${item.name} (x${item.quantity}) - R${itemTotal.toFixed(2)}`;
                cartItems.appendChild(itemDiv);
            });

            if (deliveryCheckbox.checked) {
                total += 220;
            }

            totalElement.textContent = total.toFixed(2);
        }

        deliveryCheckbox.addEventListener('change', renderCart);

        function checkout() {
            alert(`Total amount to pay: R${totalElement.textContent}`);
        }

        renderCart();

        const yocoSDK = new window.YocoSDK({ publicKey: 'pk_test_ed3c54a6gOol69qa7f45' });
        document.getElementById("popup-pay").addEventListener("click", function () {
            yocoSDK.showPopup({
                currency: 'ZAR',
                amountInCents: totalElement.textContent * 100,
                name: 'Isintu Siyabukwa',
                callback: response => {
                    if (response.error) {
                        document.getElementById("popup-message").innerText = response.error.message;
                    } else {
                        processPayment(response.id, "popup-message");
                    }
                }
            });
        });

        function processPayment(token, messageElement) {
            axios.post('http://localhost:3000/pay', { token })  // Call your backend
    .then(response => {
        document.getElementById(messageElement).innerText = response.data.status;
        window.location.href = '/';
    })
    .catch(error => {
        document.getElementById(messageElement).innerText = error.response ? error.response.data.displayMessage : "Payment Failed. Please try again later";
    });
        }
 
    </script>

</body>
</html>
