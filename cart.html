<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles.css">

    <title>Cart.html</title>
</head>
<body>
    <div class="cart-container">
        <h2>Shopping Cart</h2>
        <div id="cart-items"></div>
        <p><strong>Total: R<span id="total">0.00</span></strong></p>

        <label>
            <input type="checkbox" id="delivery"> Add Delivery (R220)
        </label>

        <div class="popup">
            <button id="popup-pay">Checkout</button>
            <p class="popup-message" id="popup-message"></p>
        </div>
    </div>
    <script src="https://js.yoco.com/sdk/v1/yoco-sdk-web.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>


    <script type="module" defer>
       
       import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = 'https://mhkcavrzuobyovapylxv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oa2NhdnJ6dW9ieW92YXB5bHh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMxNjMwMTQsImV4cCI6MjA1ODczOTAxNH0.VP7wJN9q5yLeC9grWZ2rWkJBd3le4JFenOa-oPKSyzc';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let cartItems = document.getElementById('cart-items');
    let totalElement = document.getElementById('total');
    let deliveryCheckbox = document.getElementById('delivery');
    let userEmail = localStorage.getItem("userEmail");
    console.log('user email', userEmail)

    let currentUser = null;

    async function checkAuth() {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            currentUser = user;
            loadCart();
        } else {
            alert("Please sign in to view your cart.");
            window.location.href = "/login.html"; 
        }
    }

    async function loadCart() {
        if (!currentUser) return;

        const { data: cartItemsData, error } = await supabase
            .from("cart")
            .select("*")
            .eq("user_id", currentUser.id);

        if (error) {
            console.error("Error loading cart:", error);
            return;
        }

        renderCart(cartItemsData);
    }

    function renderCart(cart) {
    cartItems.innerHTML = "";
    let total = 0;

    if (cart.length === 0) {
        cartItems.innerHTML = "<p>Your cart is empty.</p>";
        return;
    }

    cart.forEach(item => {
        let itemTotal = item.price * item.quantity;
        total += itemTotal;

        let itemDiv = document.createElement('div');
        itemDiv.classList.add("cart-item");
        itemDiv.innerHTML = `
            <span>${item.product_name} (x${item.quantity})</span>
            <span>R${itemTotal.toFixed(2)}</span>
            <button class="delete-btn" data-id="${item.id}">üóëÔ∏è</button>
        `;
        cartItems.appendChild(itemDiv);
    });

    if (deliveryCheckbox.checked) {
        total += 220;
    }

    totalElement.textContent = total.toFixed(2);

    
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', async (event) => {
            const itemId = event.target.getAttribute('data-id');
            await deleteCartItem(itemId);
        });
    });
}

    deliveryCheckbox.addEventListener('change', loadCart);

    async function deleteCartItem(itemId) {
    const { error } = await supabase
        .from("cart")
        .delete()
        .eq("id", itemId);

    if (error) {
        console.error("Error deleting item:", error);
        alert("Failed to remove item. Please try again.");
    } else {
        loadCart(); 
    }
}


    async function checkout() {
        alert(`Total amount to pay: R${totalElement.textContent}`);
    }

    document.getElementById("popup-pay").addEventListener("click", function () {
        const yocoSDK = new window.YocoSDK({ publicKey: 'pk_test_ed3c54a6gOol69qa7f45' });

        yocoSDK.showPopup({
            currency: 'ZAR',
            amountInCents: parseFloat(totalElement.textContent) * 100,
            name: 'Isintu Siyabukwa',
            callback: response => {
                if (response.error) {
                    document.getElementById("popup-message").innerText = response.error.message;
                } else {
                    processPayment(response.id, "popup-message", userEmail);
                }
            }
        });
    });

    function processPayment(token, messageElement, email) {
        axios.post('http://localhost:3000/pay', { token, email })
            .then(response => {
                document.getElementById(messageElement).innerText = response.data.status;
                window.location.href = '/';
            })
            .catch(error => {
                document.getElementById(messageElement).innerText = error.response 
                    ? error.response.data.displayMessage 
                    : "Payment Failed. Please try again later";
            });
    }

    document.addEventListener("DOMContentLoaded", checkAuth);
    </script>

</body>
</html>
